<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Knuusper</title>
    <link rel="stylesheet" href="../Index.css">
    <link rel="stylesheet" href="data.css">
</head>
<body>
    <nav>
        <div class="logo">
            <span class="blau">Knu</span>
            <span class="lila">usper</span>
            <span class="blau">/</span>
            <span class="lila">DTS</span>
        </div>
        <ul>
            <li><a class="blau" href="../index.html">Home</a></li>
            <li><a class="lila" href="../Projekte.html">Projekte</a></li>
            <li><a class="blau" href="../kontakt.html">Kontakt</a></li>
        </ul>
    </nav>
    <main>
        
        <label>Startdatum: <input type="date" id="startDate"></label>
        <label>Enddatum: <input type="date" id="endDate"></label>
        <br><br>
        <input type="file" id="fileInput" multiple accept=".json">
        <button id="analyzeBtn">Analysieren</button>

        <div id="results"></div>
    </main>
    <script>
        function convertMsToTime(ms) {
            const seconds = Math.floor(ms / 1000);
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            return { hours, minutes };
        }

        async function analyzeStreamingData(files, startDate, endDate) {
            let totalDuration = 0;
            const songsCounter = {};
            const artistsCounter = {};

            for (const file of files) {
                try {
                    const text = await file.text();
                    const data = JSON.parse(text);

                    data.forEach(entry => {
                        const timestamp = entry.ts || "";
                        if (timestamp) {
                            const entryDate = new Date(timestamp.substring(0, 10));
                            if (entryDate >= startDate && entryDate <= endDate) {
                                const msPlayed = entry.ms_played || 0;
                                totalDuration += msPlayed;

                                const songName = entry.master_metadata_track_name;
                                const artistName = entry.master_metadata_album_artist_name;

                                if (songName) {
                                    songsCounter[songName] = (songsCounter[songName] || 0) + msPlayed;
                                }
                                if (artistName) {
                                    artistsCounter[artistName] = (artistsCounter[artistName] || 0) + msPlayed;
                                }
                            }
                        }
                    });
                } catch (err) {
                    console.error(`Fehler beim Laden von ${file.name}`, err);
                }
            }

            const topSongs = Object.entries(songsCounter)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10)
                .map(([song, duration]) => [song, convertMsToTime(duration)]);

            const topArtists = Object.entries(artistsCounter)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10)
                .map(([artist, duration]) => [artist, convertMsToTime(duration)]);

            const totalSeconds = Math.floor(totalDuration / 1000);
            const totalHours = Math.floor(totalSeconds / 3600);
            const totalMinutes = Math.floor((totalSeconds % 3600) / 60);
            const totalSecs = totalSeconds % 60;

            return { topSongs, topArtists, totalTime: { totalHours, totalMinutes, totalSecs } };
        }

        document.getElementById("analyzeBtn").addEventListener("click", async () => {
            const startDateInput = document.getElementById("startDate").value;
            const endDateInput = document.getElementById("endDate").value;
            const files = document.getElementById("fileInput").files;

            if (files.length === 0) {
                alert("Bitte mindestens eine JSON-Datei hochladen.");
                return;
            }

            // Standardwerte setzen, falls leer
            const startDate = startDateInput ? new Date(startDateInput) : new Date("0000-01-01");
            const endDate = endDateInput ? new Date(endDateInput) : new Date("9999-01-01");

            if (startDate > endDate) {
                alert("Das Startdatum muss vor dem Enddatum liegen.");
                return;
            }

            const { topSongs, topArtists, totalTime } = await analyzeStreamingData(files, startDate, endDate);

            let html = `<h2>Zeitraum: ${startDate.toISOString().split('T')[0]} bis ${endDate.toISOString().split('T')[0]}</h2>`;
            html += `<h3>Top 10 Songs</h3><ol>`;
            topSongs.forEach(([song, time]) => {
                html += `<li>${song}: ${time.hours} Stunden, ${time.minutes} Minuten</li>`;
            });
            html += `</ol>`;

            html += `<h3>Top 10 KÃ¼nstler</h3><ol>`;
            topArtists.forEach(([artist, time]) => {
                html += `<li>${artist}: ${time.hours} Stunden, ${time.minutes} Minuten</li>`;
            });
            html += `</ol>`;

            html += `<p><strong>Gesamtdauer:</strong> ${totalTime.totalHours} Stunden, ${totalTime.totalMinutes} Minuten, ${totalTime.totalSecs} Sekunden</p>`;

            document.getElementById("results").innerHTML = html;
        });
    </script>
</body>
</html>